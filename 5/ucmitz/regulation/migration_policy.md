# マイグレーション方針

## 共通

### File / Folder の取り扱い
CakePHP4 から、File、Folder クラスは非推奨となり、SplFileInfo、SplFileObject の利用が推奨されていますが、
baserCMSでは利用箇所が多いため、一旦、そのまま利用してください。
　
### クラスメンバー変数へのアクセス
メンバー変数への直接アクセスはせず、セッター、ゲッターを配置するようにしてください。

　
## コントローラー
### サービスへの移行
ファットコントローラーを防ぐため、ビジネスロジックはサービスへの移行を行います。  
サービスの受取は、DIにより引数に注入する前提としインターフェイスを指定します。

```php
// URLよりのパラメーターは、サービスクラスの次の引数にセットされる
// /baser/admin/baser-core/utilities/log_maintenance/delete
// 上記URLの場合、delete が $mode にセットされる
public function log_maintenance(
    UtilitiesServiceInterface      $service,
    UtilitiesAdminServiceInterface $adminService,
    string                         $mode = '')
{
  
}
```
### テーブルへの直接アクセス不可
テーブルへは直接アクセスしないようにし、サービスを経由させるようにします。

### AjaxのAPIコントローラーへ移行
Ajaxのリクエスト対象の処理は、API用のコントローラーに移行し、戻り値をJSON化してください。
どうしてもHTMLレンダリングが必要な場合のみ、Admin 用のコントローラーに配置します。

　
## モデル
### サービスへの移行
CakePHP2系のモデルはテーブルへと移行となりますが、ファットモデルを防ぐため、
移行するメソッドのうち、できるだけ対象となるエンティティの処理だけをテーブルにまとめあげ、
外部のテーブルとの連携した処理を行うメソッドは、サービスへの移行を検討します。
### 引数
引数はリクエストを直接受け取るような事をせず、シグネチャをはっきりさせ仕様を明確化します。

　
## サービス
### テスタブルなコードにする
クラスにはテーブル以外のデータを持たせず、各メソッドについて簡潔な処理となるようにします。

　
## ビュー
### ビューで利用するデータの取得
ビューのテンプレートは、できるだけシンプルにするため、データの生成処理などを書かず、コントローラーかもしくはヘルパより取得します。

#### コントローラーから取得
コントローラー内の処理が煩雑にならないよう、対象のサービスクラスを継承した、データ取得用のサービスクラスを準備し、一括で取得しビューに引き渡すようにしましょう。

データ取得用のサービスクラスの名称は、管理画面用の場合は、末尾に `AdminService` を付け、フロントエンド用の場合は、`FrontService` を付けます。

```php
UsersAdminService
UsersFrontService
```
取得用のメソッド名は、先頭に `getViewVarsFor` を付けて統一性を保つようにします。

```php
getViewVarsForAdd
```

```php
// ユーザー管理の新規登録画面の場合
public function add(UsersAdminServiceInterface $adminService)
{
    $this->set($adminService->getViewVarsForAdd());
}
```

#### ヘルパから取得

対象画面でしか利用しないようなデータは、専用のヘルパを準備します。

ヘルパの名称は、管理画面用の場合は、末尾に `AdminHelper` を付け、フロントエンド用の場合は、`FrontHelper` を付けます。

```php
UsersAdminHelper
UsersFrontHelper
```

　
## ユニットテスト

### フィクスチャ
CakePHP4.3 より、フィクスチャマネージャーが非推奨になりました。  
新しく作成するコードは、フィクスチャマネージャーではなく、フィクスチャファクトリーを利用して作成します。

参考：[フィクスチャの利用](../test/fixture)
　

　
