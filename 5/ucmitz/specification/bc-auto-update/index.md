# オートアップデート設計書

## アップデートでやること

- アップデート情報の取得
- ファイルの上書き
- DBの更新
- その他の処理

### アップデート情報の取得
RSS で取得
https://packagist.org/feeds/package.baserproject/baser-core.rss

### ファイルの上書き
手段
- FTPで上書き（最初にFTPでアップロードしたユーザーと同じユーザー）
  - Webサーバー権限では上書きできない場合がある
- Composer
  - baserコアを vendor に入れる前提で配布する必要あり
    - plugins 配下を削除して配布
    - composer.json の replace を削除して配布

#### テスト
古いバージョンでテストする
- composer.json の replace を除外
- composer.json require の番号を書き換える
- composer update を実行
- composer.json require の番号を書き換える
- バージョン番号をチェック
- composer.json の replace を戻す
- composer.json require の番号を戻す

### DBの更新
- マイグレーション

#### 実行条件
- composer が完了している事

#### テスト
- マイグレーション実行
- 失敗した場合にComposer を巻き戻す

## その他の処理
- アップデートスクリプト実行

## 懸念事項
新しいプログラムが新しいデータベース、アップデートスクリプトの実行を前提としているプログラムの場合。
処理が止まる可能性がある。



---

## 現在の処理

BcUpdateFilterMiddleware にてプログラムの変化を確認  
→ いらなくなる  

/update に移動する事でアップデート画面へ  
→ ルーティングを削除

UpdatersController::update()

データベースのマイグレーションとアップロードプログラムのみ実行
- PluginsService::update()
- Plugin::update()


## 外部プラグインの取り扱い
当面は plugins にインストール


## 外部プラグインの将来的な取り扱い

### インストール
baserマーケットでAPIを公開

- プラグイン管理からプラグインを検索
- インストールをクリック
- マーケットにログインしていない場合はログイン画面に遷移
- ログインすると対象プラグインの購入情報を取得
- 購入していない場合はカートに登録
- 購入完了後、プラグインインストール画面に遷移
- インストール実行をクリック
- プラグインをダウンロード
  - composer に対応しているものは、composerで vendorにダウンロード
  - composer に対応していないものは、マーケットから、plugins にダウンロード
- インストール実行

### アップデート
- baserマーケットのAPIでアップデート情報を取得
- アップデートを実行
- マーケットにログインしていない場合はログイン画面に遷移
- ログインすると対象プラグインの購入情報を取得
- 購入していない場合はカートに登録
- 購入完了後、プラグインアップデート画面に遷移
- アップデート実行をクリック
- プラグインをダウンロード
  - composer に対応しているものは、composerで vendorにダウンロード
  - composer に対応していないものは、マーケットから、plugins にダウンロード
- アップデート実行
